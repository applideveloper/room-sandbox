"undefined"==typeof room&&(room={}),$(function(){var a={log:function(){}},b={maxRetry:5,retryInterval:1e3,logger:a};room.Connection=function(a){function c(b){if(p.log("request",b),!m())return void(v<a.maxRetry&&(k(function(){c(b)}),u||(socket=n())));a.onRequest&&a.onRequest(b.command,b.data);var d=(new Date).getTime(),e=++q;r[e]=d,b.success&&(s[e]=b.success);var f={id:e,command:b.command,data:b.data};return b.log&&(f.log=b.log),socket.send(JSON.stringify(f)),o}function d(a,b){return s[a]=b,o}function e(a){return delete s[a],o}function f(b){u=!1,p.log("onOpen",a.url),a.onOpen&&a.onOpen(b),v=0,a.authToken&&c({command:"room.auth",data:a.authToken,success:function(b){"OK"==b.status&&b.token&&(a.authToken=b.token)}});for(var d=0;d<t.length;d++)t[d]();t=[]}function g(b){p.log("receive",b.data);var c=JSON.parse(b.data),d=r[c.id],e=null;return d&&delete r[c.id],a.onMessage&&a.onMessage(c,d),"error"==c.type?void(a.onServerError&&a.onServerError(c.data)):(c.id&&s[c.id]?(e=s[c.id],delete s[c.id]):c.command&&s[c.command]&&(e=s[c.command]),void(e?e(c.data):p.log("UnknownMessage",b.data)))}function h(b){p.log("close",a.url),a.onClose&&a.onClose(b),v<a.maxRetry&&(v++,setTimeout(function(){socket=n()},1e3*v))}function i(b){a.onSocketError&&a.onSocketError(b)}function j(a,b){return setInterval(function(){m()&&c($.extend(!0,{},b))},a)}function k(a){m()?a():t.push(a)}function l(){m()&&(v=a.maxRetry,socket.close())}function m(){return 1==socket.readyState}function n(){u=!0;var b=new WebSocket(a.url);return b.onopen=f,b.onmessage=g,b.onerror=i,b.onclose=h,b}"string"==typeof a&&(a={url:a}),a=$.extend({},b,a);var o=this,p=a.logger,q=0,r={},s={},t=[],u=!1,v=0;socket=n(),$.extend(this,{request:c,addEventListener:d,removeEventListener:e,polling:j,ready:k,close:l,isConnected:m,onOpen:function(b){return a.onOpen=b,this},onClose:function(b){return a.onClose=b,this},onRequest:function(b){return a.onRequest=b,this},onMessage:function(b){return a.onMessage=b,this},onSocketError:function(b){return a.onSocketError=b,this},onServerError:function(b){return a.onServerError=b,this}})}});