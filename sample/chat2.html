<html>
<head>
<title>Chat sample</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="javascripts/room.connection.js"></script>
</head>
<body>
<h1>Chat2</h1>
<div>
Name: <input type="text" id="name" size="10"> 
Message: <input type="text" id="message" size="40">
</div>
<div id="logs">
</div>
<script>
$(function() {
	function generateId() {
		var n = new Date().getTime() + Math.random()
		return ("p" + n).replace(".", "");
	}
	var host = location.search.indexOf("local=true") > 0 ? "localhost:9000" : "room-sandbox.herokuapp.com",
		ws = new room.Connection("ws://" + host + "/shunjikonishi/roomframeworknotest"),
		$logs = $("#logs"),
		$msg = $("#message"),
		$name = $("#name"),
		id = generateId();
	ws.addEventListener("chat", function(data) {
		var $p = $("#" + data.id);
console.log("data.id: " + $p.length + ", " + data.id);
		if ($p.length == 0) {
			$p = $("<p/>");
			$p.attr("id", data.id);
			$logs.append($p);
		}
		$p.text(data.name + ": " + data.msg);
	});
	$msg.keydown(function(event) {
		setTimeout(function() {
			if ($msg.val()) {
				var data = {
					"id" : id,
					"name" : $name.val() || "NoName",
					"msg" : $msg.val()
				};
				ws.request({
					"command" : "chat",
					"data" : data
				});
			} 
			if (event.keyCode == 13) {
				id = generateId();
				$msg.val("");
			}
		}, 0);
	});
})
</script>
</body>
</html>