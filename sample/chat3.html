<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat sample</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="javascripts/roomframework.js"></script>
</head>
<body>
<div class="container">
	<h1>Chat3</h1>
	<div class="row">
		<div class="col-xs-4">
			Name: <input type="text" id="name" class="form-control"> 
		</div>
		<div class="col-xs-8">
			Message: <input type="text" id="message" class="form-control">
		</div>
	</div>
	<div class="row" style="margin-top:20px;">
		<div id="logs" class="col-xs-12">
		</div>
	</div>
	<hr>
	<div class="row" style="margin-top:20px;">
		<div id="console" class="col-xs-12">
		</div>
	</div>
</div>
<script>
$(function() {
	function generateId() {
		var n = new Date().getTime() + Math.random()
		return ("p" + n).replace(".", "");
	}
console.log("test1");
	var host = location.search.indexOf("local=true") > 0 ? "localhost:9000" : "room-sandbox.herokuapp.com",
		ws = new room.Connection({
			"url": "ws://" + host + "/shunjikonishi/roomframeworknotest",
			"logger": new room.logger.DivLogger($("#console"))
		}), 
		$logs = $("#logs"),
		$msg = $("#message"),
		$name = $("#name"),
		id = generateId();
console.log("test1");
	ws.addEventListener("chat", function(data) {
		var $p = $("#" + data.id);
		if ($p.length == 0) {
			$p = $("<p/>");
			$p.attr("id", data.id);
			$logs.prepend($p);
		}
		$p.text(data.name + ": " + data.msg);
	});
	$msg.keydown(function(event) {
		setTimeout(function() {
			if ($msg.val()) {
				var data = {
					"id" : id,
					"name" : $name.val() || "NoName",
					"msg" : $msg.val()
				};
				ws.request({
					"command" : "chat",
					"data" : data
				});
			} 
			if (event.keyCode == 13) {
				id = generateId();
				$msg.val("");
			}
		}, 0);
	});
})
</script>
</body>
</html>